---
name: ğŸš€ Publish Release
on:
  release:
    types: [published]
permissions:
  contents: read
  id-token: write # Needed for PyPI trusted publishing
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true
jobs:
  publish:
    name: ğŸ“¦ Publish ${{ matrix.package }}
    runs-on: ubuntu-latest
    env:
      ACTIONS_STEP_DEBUG: ${{ secrets.ACTIONS_DEBUG || 'false' }}
    strategy:
      matrix:
        package:
          - haive-core
          - haive-agents
          - haive-games
          - haive-tools
          - haive-prebuilt
          - haive-dataflow
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_TOKEN }}
      - name: ğŸ“¦ Get Poetry Metadata
        id: poetry
        uses: ./.github/actions/get-poetry-info
      - name: ğŸ§¾ Echo Package Metadata
        run: |
          echo "ğŸ“¦ Name:        ${{ steps.poetry.outputs.name }}"
          echo "ğŸ”– Version:     ${{ steps.poetry.outputs.version }}"
          echo "ğŸ§‘ Authors:     ${{ steps.poetry.outputs.authors }}"
          echo "ğŸ“„ License:     ${{ steps.poetry.outputs.license }}"
          echo "ğŸ“ Description: ${{ steps.poetry.outputs.description }}"
          echo "ğŸŒ Homepage:    ${{ steps.poetry.outputs.homepage }}"
          echo "ğŸ”— Repository:  ${{ steps.poetry.outputs.repository }}"
          echo "ğŸ“š Docs:        ${{ steps.poetry.outputs.documentation }}"
          echo "ğŸ· Classifiers:"
          echo "${{ steps.poetry.outputs.classifiers }}"
      - name: ğŸ Set up Python ${{ steps.poetry.outputs.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ steps.poetry.outputs.python }}
          cache: poetry
      - name: ğŸ›  Install Poetry
        run: pipx install poetry==1.8.0
      - name: ğŸ” Configure PyPI Credentials
        run: poetry config pypi-token.pypi ${{ secrets.PYPI_TOKEN }}
      - name: ğŸ“¦ Build and Publish ${{ matrix.package }}
        run: |-
          cd packages/${{ matrix.package }}
          poetry build --format wheel
          poetry publish --skip-existing
